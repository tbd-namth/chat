<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title></title>
  <style>
    /* ========== Reset / Base ========== */
    :root {
      --accent-1: #007991;
      --accent-2: #78ffd6;
      --bg-1: #0f2027;
      --bg-2: #2c5364;
    }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; padding:0; font-family: 'Roboto', sans-serif; }

    /* Body background */
    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(135deg, var(--bg-1), #203a43, var(--bg-2));
      color: #ffffff;
    }

    /* Chat Container */
    .chat-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 420px;
      height: 85vh;
      border-radius: 15px;
      background: rgba(20, 20, 20, 0.95);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8), 0 0 20px rgba(0, 255, 255, 0.12);
      overflow: hidden;
      border: 1px solid rgba(0, 255, 255, 0.08);
    }

    /* Header */
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      color: #ffffff;
      font-size: 1.05rem;
      font-weight: 700;
      gap: 10px;
      background-image: url('https://i.postimg.cc/g2nVKBFx/Screenshot-20241214-152909-Canva.jpg');
      background-size: cover;
      background-position: center;
    }
    .header-left { display:flex; align-items:center; gap:10px; }
    .logo { width:36px; height:36px; border-radius:50%; border:2px solid #fff; object-fit:cover; }

    .language-select { display:flex; gap:6px; }
    .lang-button {
      background: rgba(255,255,255,0.12);
      color: #fff;
      border: 1px solid rgba(0,255,255,0.18);
      border-radius: 12px;
      padding: 6px 10px;
      font-size:0.85rem;
      cursor:pointer;
    }
    .lang-button.active {
      background: rgba(0,255,255,0.7);
      color:#000;
      border: none;
    }

    /* Chat body */
    .chat-body {
      flex:1;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow-y:auto;
      background-color: rgba(0,0,0,0.6);
      background-image: url('https://i.postimg.cc/Rh1Tt3t4/20241214-153823-0000.png');
      background-size: cover;
      background-position: center;
    }

    /* Message */
    .message {
      display:flex;
      align-items:flex-end;
      gap:10px;
      max-width:70%;
      padding:12px 14px;
      border-radius:18px;
      font-size:0.95rem;
      box-shadow: 0 5px 12px rgba(0,0,0,0.25);
      word-wrap:break-word;
      overflow-wrap:break-word;
      flex-shrink:0;
    }
    .message.user {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--accent-2), var(--accent-1));
      border-top-right-radius:6px;
      color:#002;
    }
    .message.bot {
      align-self: flex-start;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      border-top-left-radius:6px;
      color:#001;
    }
    .message img { width:34px; height:34px; border-radius:50%; object-fit:cover; }

    /* Thinking */
    .thinking {
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px;
      max-width:70%;
    }
    .thinking img { width:34px; height:34px; border-radius:50%; border:2px solid rgba(0,255,255,0.45); }
    .thinking .dots { display:flex; gap:6px; }
    .thinking .dots span {
      display:inline-block; width:8px; height:8px; background:#00ffff; border-radius:50%;
      animation: blink 1.4s infinite ease-in-out;
      opacity:0;
    }
    .thinking .dots span:nth-child(2) { animation-delay:0.25s; }
    .thinking .dots span:nth-child(3) { animation-delay:0.5s; }
    @keyframes blink {
      0%,80%,100% { opacity:0; transform:translateY(0); }
      40% { opacity:1; transform:translateY(-3px); }
    }

    /* Footer */
    .chat-footer {
      display:flex;
      align-items:center;
      padding:10px;
      gap:8px;
      border-top:1px solid rgba(255,255,255,0.05);
      background: rgba(20,20,20,0.9);
    }
    .chat-footer input {
      flex:1; padding:12px 14px; border-radius:22px; border:none; outline:none;
      background: rgba(255,255,255,0.06); color:#fff; font-size:0.95rem;
      box-shadow: inset 0 2px 6px rgba(0,0,0,0.45);
    }
    .chat-footer button {
      width:44px; height:44px; border-radius:50%; border:none; cursor:pointer;
      background: linear-gradient(135deg,var(--accent-1),var(--accent-2));
      color:#fff; font-size:1.1rem;
      box-shadow: 0 6px 16px rgba(0,255,255,0.16);
      display:flex; align-items:center; justify-content:center;
    }
    .chat-footer button:hover { transform:scale(1.06); transition:0.15s ease; }

    /* Responsive */
    @media (max-width:480px){
      .chat-container { width:100%; height:92vh; border-radius:0; }
      .logo { width:30px; height:30px; }
    }
  </style>
</head>
<body>
  <div class="chat-container" role="application" aria-label="Chatbot">
    <div class="chat-header">
      <div class="header-left">
        <img class="logo" id="header-logo" src="https://i.postimg.cc/vZ3K4K7D/1-20241214-153021-0000.png" alt="logo">
        <div>
          <div id="chat-title">TBD Chatbot</div>
          <div style="font-size:0.75rem; opacity:0.9;" id="chat-subtitle">Simple local chatbot (English / ‡πÑ‡∏ó‡∏¢)</div>
        </div>
      </div>
      <div class="language-select" aria-hidden="false">
        <button id="lang-en" class="lang-button">EN</button>
        <button id="lang-th" class="lang-button">TH</button>
      </div>
    </div>

    <div id="chat-body" class="chat-body" role="log" aria-live="polite"></div>

    <div class="chat-footer">
      <input id="user-input" placeholder="Type a message..." aria-label="Type a message" />
      <button id="send-button" title="Send">‚û§</button>
    </div>
  </div>

  <script>
    // ======= Configuration & Assets =======
    let language = localStorage.getItem('chat_lang') || 'en'; // 'en' or 'th'

    const userName = "You";
    const botName = "TBD";
    const userAvatar = "https://img5.pic.in.th/file/secure-sv1/1000049084ea52cf432a302e47.jpg";
    const botAvatar = "https://i.postimg.cc/vZ3K4K7D/1-20241214-153021-0000.png";

    // ======= Predefined Replies (keys are lowercase, normalized) =======
    // Note: keep these lowercase / normalized - system will normalize input before matching
    const predefinedReplies = {
      en: {
        "hello": "Hi! How can I assist you?",
        "hi": "Hi! How can I assist you?",
        "how are you": "I'm doing great, thank you for asking!",
        "what is your name": "I'm Chatbot, nice to meet you!",
        "good morning": "Good morning! How can I help you today?",
        "good night": "Good night! Sleep well!",
        "what is your purpose": "I am here to help you with anything you need.",
        "tell me a joke": "Why don‚Äôt skeletons fight each other? They don‚Äôt have the guts!",
        "how can i help you": "You can ask me questions or tell me what you need help with!",
        "what is the weather like": "I‚Äôm sorry, I can't check the weather right now.",
        "what time is it": "I'm sorry, I can't check the time for you.",
        "how old are you": "I don‚Äôt have an age, I'm just a chatbot!",
        "what do you like to do": "I like to chat and help people.",
        "where are you from": "I‚Äôm from the digital world!",
        "can you help me": "Of course! What do you need help with?",
        "what is your favorite color": "I don‚Äôt have a favorite color, but I think blue is nice.",
        "do you have emotions": "No, I don‚Äôt experience emotions, but I‚Äôm designed to be helpful.",
        "are you real": "I‚Äôm real in the digital sense, but I‚Äôm not a human.",
        "tell me a story": "Once upon a time, there was a chatbot who loved to help people...",
        "can you speak any other languages": "Yes, I can chat in multiple languages.",
        "what is love": "Love is a deep feeling of affection, but I can‚Äôt experience it.",
        "who is the president": "I don't have real-time info, but you can look it up online.",
        "are you a robot": "I‚Äôm not a robot, I‚Äôm a chatbot!",
        "what is 2+2": "2 + 2 is 4.",
        "what is the capital of france": "The capital of France is Paris.",
        "what is your favorite food": "I don‚Äôt eat food, but I know a lot about it.",
        "can you play games": "I can‚Äôt play games, but I can help you find some!",
        "do you like music": "I can‚Äôt listen to music, but I know about different types.",
        "what is the meaning of life": "The meaning of life is subjective, but many say it‚Äôs about finding happiness."
      },
      th: {
        "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ! ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°?",
        "hello": "Please select English",
        "hi": "Please select English",
        "‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á": "‡∏â‡∏±‡∏ô‡∏™‡∏ö‡∏≤‡∏¢‡∏î‡∏µ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ñ‡∏≤‡∏°!",
        "‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏£": "‡∏â‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ä‡∏ó‡∏ö‡∏≠‡∏ó ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å!",
        "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤! ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°?",
        "‡∏£‡∏≤‡∏ï‡∏£‡∏µ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå": "‡∏£‡∏≤‡∏ï‡∏£‡∏µ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå! ‡∏´‡∏•‡∏±‡∏ö‡∏ù‡∏±‡∏ô‡∏î‡∏µ!",
        "‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£": "‡∏â‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£",
        "‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏•‡∏Å‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á": "‡∏ó‡∏≥‡πÑ‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏™‡∏π‡πâ‡∏Å‡∏±‡∏ô? ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ guts!",
        "‡∏â‡∏±‡∏ô‡∏à‡∏∞‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°": "‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô! ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏â‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏∞‡πÑ‡∏£?",
        "‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£": "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏© ‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ",
        "‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏á": "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏© ‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ",
        "‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà": "‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏â‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ä‡∏ó‡∏ö‡∏≠‡∏ó!",
        "‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≠‡∏ö‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£": "‡∏â‡∏±‡∏ô‡∏ä‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏ó‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏Ñ‡∏ô",
        "‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏´‡∏ô": "‡∏â‡∏±‡∏ô‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÇ‡∏•‡∏Å‡∏î‡∏¥‡∏à‡∏¥‡∏ï‡∏≠‡∏•!",
        "‡∏Ñ‡∏∏‡∏ì‡∏ä‡πà‡∏ß‡∏¢‡∏â‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°": "‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô! ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏â‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏∞‡πÑ‡∏£?",
        "‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≠‡∏ö‡∏™‡∏µ‡∏≠‡∏∞‡πÑ‡∏£": "‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏µ‡πÇ‡∏õ‡∏£‡∏î ‡πÅ‡∏ï‡πà‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏Å‡πá‡∏î‡∏π‡∏î‡∏µ‡∏ô‡∏∞",
        "‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÑ‡∏´‡∏°": "‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å ‡πÅ‡∏ï‡πà‡∏â‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì",
        "‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°": "‡∏â‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏ó‡∏≤‡∏á‡∏î‡∏¥‡∏à‡∏¥‡∏ï‡∏≠‡∏• ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå",
        "‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢": "‡∏Å‡∏≤‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏°‡∏µ‡πÅ‡∏ä‡∏ó‡∏ö‡∏≠‡∏ó‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏Ñ‡∏ô...",
        "‡∏Ñ‡∏∏‡∏ì‡∏û‡∏π‡∏î‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°": "‡πÉ‡∏ä‡πà ‡∏â‡∏±‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ä‡∏ó‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏©‡∏≤",
        "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£": "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏•‡∏∂‡∏Å‡∏ã‡∏∂‡πâ‡∏á ‡πÅ‡∏ï‡πà‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡πÑ‡∏î‡πâ",
        "‡πÉ‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ": "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏© ‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡πÅ‡∏ï‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏ó‡∏≤‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå",
        "‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡πÑ‡∏´‡∏°": "‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå ‡∏â‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ä‡∏ó‡∏ö‡∏≠‡∏ó!",
        "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏´‡∏•‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡∏ù‡∏£‡∏±‡πà‡∏á‡πÄ‡∏®‡∏™‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏´‡∏•‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡∏ù‡∏£‡∏±‡πà‡∏á‡πÄ‡∏®‡∏™‡∏Ñ‡∏∑‡∏≠‡∏õ‡∏≤‡∏£‡∏µ‡∏™",
        "‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≠‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£": "‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÅ‡∏ï‡πà‡∏â‡∏±‡∏ô‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó",
        "‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°": "‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏â‡∏±‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏Å‡∏°‡∏™‡∏ô‡∏∏‡∏Å‡πÜ ‡πÑ‡∏î‡πâ",
        "‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≠‡∏ö‡πÄ‡∏û‡∏•‡∏á‡πÑ‡∏´‡∏°": "‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ü‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏â‡∏±‡∏ô‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á",
        "‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£": "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ‡πÅ‡∏ï‡πà‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç",
        "‡∏ó‡∏≥‡πÑ‡∏£‡∏î‡∏µ": "‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏™‡∏¥",
        "‡∏Ç‡∏≠‡∏ï‡∏±‡∏á‡∏Ñ‡πå‡∏´‡∏ô‡πà‡∏≠‡∏¢": "‡∏´‡∏≤‡πÄ‡∏≠‡∏á‡∏™‡∏¥",
        "‡∏Ç‡∏≠‡∏ï‡∏±‡∏á‡∏Ñ‡πå": "‡∏´‡∏≤‡πÄ‡∏≠‡∏á",
        "‡∏Ç‡∏≠‡πÄ‡∏á‡∏¥‡∏ô": "‡∏´‡∏≤‡πÄ‡∏≠‡∏á‡∏™‡∏¥",
        "‡∏ô‡πà‡∏≤‡πÄ‡∏ö‡∏∑‡πà‡∏≠": "‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏™‡∏¥üòä",
        "‡πÄ‡∏®‡∏£‡πâ‡∏≤": "‡πÇ‡∏≠‡πâ‡πÜüòò",
        "‡∏ô‡∏≠‡∏ô‡∏•‡∏∞": "‡∏ù‡∏±‡∏ô‡∏î‡∏µ",
        "‡∏ó‡πâ‡∏≠‡∏•‡∏∞": "‡πÇ‡∏≠‡πâ‡πÜ ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£",
        "‡πÄ‡∏´‡∏á‡∏≤‡∏à‡∏±‡∏á": "‡∏ß‡∏≤‡∏¢‡πÜ",
        "‡πÄ‡∏´‡∏á‡∏≤": "‡∏ß‡∏≤‡∏¢‡πÜ",
        "‡∏á‡πà‡∏ß‡∏á‡∏ô‡∏≠‡∏ô": "‡πÑ‡∏õ‡∏ô‡∏≠‡∏ô‡∏™‡∏¥",
        "‡∏á‡πà‡∏ß‡∏á": "‡πÑ‡∏õ‡∏ô‡∏≠‡∏ô‡∏™‡∏¥",
        "‡πÑ‡∏õ‡∏ô‡∏≠‡∏ô‡∏•‡∏∞": "‡∏ù‡∏±‡∏ô‡∏î‡∏µ",
        "‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏Ñ‡∏£": "‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ",
        "‡πÄ‡∏à‡πá‡∏ö‡πÉ‡∏à": "‡∏™‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡πâ‡∏≤",
        "‡∏Å‡∏¥‡∏ô‡πÑ‡∏£‡∏î‡∏µ": "‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πâ‡∏°‡∏ï‡∏≥‚úÖÔ∏è",
        "55555": "‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°?",
        "‡πÑ‡∏á": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ! ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°?",
        "1+1 ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏≠‡∏∞‡πÑ‡∏£": "1 + 1 ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 2",
        "1+1=": "1 + 1 ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 2",
        "2+2 ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏≠‡∏∞‡πÑ‡∏£": "2 + 2 ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 4",
        "2+2=": "2 + 2 ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 4",
        "3+3 ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏≠‡∏∞‡πÑ‡∏£": "3 + 3 ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 6",
        "3+3=": "3 + 3 ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 6",
        "4+4 ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏≠‡∏∞‡πÑ‡∏£": "4 + 4 ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 8",
        "4+4=": "4 + 4 ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 8",
        "5+5 ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏≠‡∏∞‡πÑ‡∏£": "5 + 5 ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 10",
        "5+5=": "5 + 5 ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 10",
        "6+6 ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏≠‡∏∞‡πÑ‡∏£": "6 + 6 ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 12",
        "6+6=": "6 + 6 ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 12"
      }
    };

    // ======= DOM Elements =======
    const chatBody = document.getElementById("chat-body");
    const userInput = document.getElementById("user-input");
    const sendButton = document.getElementById("send-button");
    const langEnButton = document.getElementById("lang-en");
    const langThButton = document.getElementById("lang-th");

    // Initialize language buttons UI
    function updateLangButtonsUI() {
      if (language === 'en') {
        langEnButton.classList.add('active');
        langThButton.classList.remove('active');
        userInput.placeholder = "Type a message...";
      } else {
        langThButton.classList.add('active');
        langEnButton.classList.remove('active');
        userInput.placeholder = "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...";
      }
      localStorage.setItem('chat_lang', language);
    }
    updateLangButtonsUI();

    // ======= Utility: Normalization =======
    function normalizeText(str) {
      if (!str) return '';
      // Make lowercase, remove punctuation (basic), trim spaces, collapse multiple spaces
      return str
        .toLowerCase()
        .replace(/[^\p{L}\p{N}\s\+\-]/gu, '') // keep letters, numbers, spaces, plus/minus (for math)
        .replace(/\s+/g, ' ')
        .trim();
    }

    // ======= Levenshtein Distance (digit-by-digit style but implemented) =======
    function levenshteinDistance(a, b) {
      // Ensure inputs are strings
      a = String(a || '');
      b = String(b || '');
      const alen = a.length;
      const blen = b.length;
      if (alen === 0) return blen;
      if (blen === 0) return alen;

      // create matrix of size (blen+1) x (alen+1)
      const matrix = Array.from({length: blen + 1}, () => Array(alen + 1).fill(0));
      for (let i = 0; i <= blen; i++) matrix[i][0] = i;
      for (let j = 0; j <= alen; j++) matrix[0][j] = j;

      for (let i = 1; i <= blen; i++) {
        for (let j = 1; j <= alen; j++) {
          const cost = b.charAt(i - 1) === a.charAt(j - 1) ? 0 : 1;
          matrix[i][j] = Math.min(
            matrix[i - 1][j] + 1,        // deletion
            matrix[i][j - 1] + 1,        // insertion
            matrix[i - 1][j - 1] + cost  // substitution
          );
        }
      }
      return matrix[blen][alen];
    }

    // ======= Matching logic: exact -> includes -> fuzzy =======
    function getBestMatch(userMessage, predefined) {
      const normalizedMessage = normalizeText(userMessage);
      if (!normalizedMessage) return null;

      // Precompute keys as normalized strings
      const entries = Object.entries(predefined).map(([k,v]) => [normalizeText(k), v]);

      // 1) Exact match
      for (const [k,v] of entries) {
        if (k === normalizedMessage) return [k, v];
      }

      // 2) Substring/includes (longer messages)
      for (const [k,v] of entries) {
        if (k && normalizedMessage.includes(k)) return [k, v];
      }

      // 3) Fuzzy match (Levenshtein) - choose dynamic threshold based on length
      let best = null;
      let bestDistance = Infinity;
      for (const [k,v] of entries) {
        if (!k) continue;
        const distance = levenshteinDistance(normalizedMessage, k);
        if (distance < bestDistance) {
          bestDistance = distance;
          best = [k, v];
        }
      }
      if (!best) return null;
      // dynamic threshold: allow up to ~30% of length (rounded) or min 2
      const len = Math.max(normalizedMessage.length, best[0].length, 1);
      const threshold = Math.max(2, Math.round(len * 0.35));
      return (bestDistance <= threshold) ? best : null;
    }

    // Check keywords fallback
    function containsKeyword(userMessage, keywords) {
      if (!userMessage) return false;
      const norm = normalizeText(userMessage);
      return keywords.some(keyword => norm.includes(keyword));
    }

    // ======= Bot reply resolution =======
    function getBotReply(rawUserMessage) {
      const normalizedMessage = normalizeText(rawUserMessage);
      const predefined = predefinedReplies[language] || {};

      // 1) Check direct math small expressions like "2+2" quick-eval (safe)
      const mathMatch = normalizedMessage.match(/^(\d+(?:\.\d+)?\s*[\+\-\*\/]\s*\d+(?:\.\d+)?)$/);
      if (mathMatch) {
        try {
          // Evaluate basic arithmetic only (safe)
          // Replace any accidental spaces
          const expr = mathMatch[1].replace(/\s+/g, '');
          // Disallow unexpected chars (already filtered), evaluate using Function
          // This is basic and safe for simple arithmetic
          // eslint-disable-next-line no-new-func
          const result = Function('"use strict"; return (' + expr + ')')();
          return String(expr + " = " + result);
        } catch (e) {
          // ignore and fallthrough
        }
      }

      // 2) Matching predefined replies (exact/includes/fuzzy)
      const matched = getBestMatch(normalizedMessage, predefined);
      if (matched) {
        return matched[1];
      }

      // 3) Keyword fallback
      const keywords = language === "th" ? ["‡∏ä‡πà‡∏ß‡∏¢","‡∏ñ‡∏≤‡∏°","‡∏ö‡∏≠‡∏Å","‡∏ó‡∏≥‡πÑ‡∏á","‡∏ó‡∏≥‡∏¢‡∏±‡∏á‡πÑ‡∏á","‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£"] : ["help","question","tell","how","what"];
      if (containsKeyword(normalizedMessage, keywords)) {
        return language === "th"
          ? "‡∏â‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏∏‡∏ì‡πÄ‡πÄ‡∏ï‡πà‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á Beta"
          : "I'm ready to help you, but I may not be able to help much because the system is in Beta.";
      }

      // 4) Default fallback (randomized)
      const fallbackReplies = language === "en"
        ? ["Sorry, I don't understand. Can you try typing again?", "I'm not sure what you mean. Could you please explain more?"]
        : ["‡∏Ç‡∏≠‡πÇ‡∏ó‡∏© ‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à ‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°", "‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡∏≠‡∏∞‡πÑ‡∏£ ‡∏Ñ‡∏∏‡∏ì‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°"];
      return fallbackReplies[Math.floor(Math.random() * fallbackReplies.length)];
    }

    // ======= Chat UI helpers =======
    function addMessage(sender, text, avatar) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', sender);
      const avatarImg = document.createElement('img');
      avatarImg.src = avatar;
      avatarImg.alt = sender === 'user' ? userName : botName;

      const textDiv = document.createElement('div');
      textDiv.textContent = text;

      messageDiv.appendChild(avatarImg);
      messageDiv.appendChild(textDiv);
      chatBody.appendChild(messageDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function addThinkingAnimation() {
      const thinkingDiv = document.createElement('div');
      thinkingDiv.classList.add('thinking');
      thinkingDiv.innerHTML = `
        <img src="${botAvatar}" alt="bot">
        <div class="dots" aria-hidden="true">
          <span></span><span></span><span></span>
        </div>
      `;
      chatBody.appendChild(thinkingDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
      return thinkingDiv;
    }
    function removeThinkingAnimation(node) { if (node && node.parentNode) node.remove(); }

    // ======= Persist chat history in localStorage =======
    const HISTORY_KEY = 'chat_history_v1';
    function saveMessageToHistory(who, text) {
      try {
        const hist = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        hist.push({ who, text, ts: Date.now(), lang: language });
        // Keep last 200 messages max
        if (hist.length > 200) hist.splice(0, hist.length - 200);
        localStorage.setItem(HISTORY_KEY, JSON.stringify(hist));
      } catch (e) { /* ignore */ }
    }
    function loadHistory() {
      try {
        const hist = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        for (const msg of hist) {
          // Optionally we could filter by language, but show all
          addMessage(msg.who, msg.text, msg.who === 'user' ? userAvatar : botAvatar);
        }
      } catch (e) { /* ignore */ }
    }
    // Load existing history on start
    loadHistory();

    // ======= Sending logic =======
    function sendMessage() {
      const raw = userInput.value;
      if (!raw || !raw.trim()) return;
      const userMessage = raw.trim();
      addMessage('user', userMessage, userAvatar);
      saveMessageToHistory('user', userMessage);
      userInput.value = '';
      userInput.focus();

      // Show thinking animation
      const thinkingNode = addThinkingAnimation();

      // Simulate processing delay (short)
      setTimeout(() => {
        const reply = getBotReply(userMessage);
        removeThinkingAnimation(thinkingNode);
        addMessage('bot', reply, botAvatar);
        saveMessageToHistory('bot', reply);
      }, 2000 + Math.min(5000, Math.max(0, userMessage.length * 20))); // adjust a bit by message length
    }

    // ======= Language switching =======
    function switchLanguage(lang) {
      language = lang === 'th' ? 'th' : 'en';
      updateLangButtonsUI();
    }

    // Attach listeners
    sendButton.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    langEnButton.addEventListener('click', () => switchLanguage('en'));
    langThButton.addEventListener('click', () => switchLanguage('th'));

    // Focus input on load
    userInput.focus();

    // Accessibility: allow paste Enter
    userInput.addEventListener('paste', () => setTimeout(() => userInput.focus(), 50));

    // Optional: greet user once when chat empty
    (function greetOnce() {
      const hist = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      if (!hist || hist.length === 0) {
        const greet = language === 'th' ? '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ! ‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏ä‡∏ó‡∏ö‡∏≠‡∏ó ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°?' : 'Hello! I am a chatbot ‚Äî how can I help you?';
        addMessage('bot', greet, botAvatar);
        saveMessageToHistory('bot', greet);
      }
    })();
  </script>
</body>
</html>
